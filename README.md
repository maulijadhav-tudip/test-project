![Logo](./front-end/public/logo.png)

# Palo Alto Networks Project Cloudspin

> This is a web application to connect end-users to the Palo Alto Networks Hands On Workshop and Ultimate Test Drive environments hosted on the Ravello cloud. It allows Administrators to schedule classes either by pre-creating an environment for each student before hand, or allowing the student to register on the spot. It also allows for a student to request a lab. The students can login through this app and access the Ravello Cloud Environment or receive an email from Cloudshare with access to an environment.

## Installing the application in production on a Server

### Automatically

The "deployment.sh" script obtained from either Box or an AMI can be used to automatically deploy a portal with very little interaction.
First copy the script, a .env file as described below, and the docker-compose file to the home directory of your server. To select a version of the portal to run find all of the "image" declarations in the docker compose file and update the image tag to the desired version. Make the script executable and run as root. Enter FQDN of the server you have created, your AWS Secret Key, and your AWS Access key. These keys must have access to the AWS ECR where the containers are stored. The script will then install all necessary dependencies and deploy a fully working copy of the portal with SSL enabled.

###### Changing .env file after deployment

```shell
sudo docker-compose up -d
```

Then you will need to replace the self-signed certificate in the container with the ones generated by letsencrypt using the following commands replacing $FQDN with the domain name of the server. This process is done automatically by the setup script. It only needs to be done if the .env file is changed after initial setup.

```shell
sudo docker cp -L /etc/letsencrypt/live/$FQDN/fullchain.pem front-end:/etc/letsencrypt/live/fullchain.pem
sudo docker cp -L /etc/letsencrypt/live/$FQDN/privkey.pem front-end:/etc/letsencrypt/live/privkey.pem
sudo docker-compose restart front-end
```

###### Updating after deployment

To change to a different version of cloudspin after deployment first edit the docker-compose.yml file by changing all of the image tags to the desired version. Then run the following. This will download the new containers and replace the self signed certificate with the letsencrypt ones.

```shell
sudo docker-compose up -d
sudo docker cp -L /etc/letsencrypt/live/$FQDN/fullchain.pem front-end:/etc/letsencrypt/live/fullchain.pem
sudo docker cp -L /etc/letsencrypt/live/$FQDN/privkey.pem front-end:/etc/letsencrypt/live/privkey.pem
sudo docker-compose restart front-end
```

### Manual server setup

The build process requires at least 1Gb of RAM. Please run this on at least an AWS t2.Small machine. The machine can be downsized after the initial build.

Clone the Code Repo from bitbucket:

```shell
git clone https://YOUR_USERNAME_HERE@bitbucket.org/cloudspin/cloudspin.git
```

Install Docker
https://docs.docker.com/install/linux/docker-ce/ubuntu/

Install Docker-compose (not needed on Windows or OSX)  
https://docs.docker.com/compose/install/#install-compose

Install the AWS CLI and configure it.

https://docs.aws.amazon.com/cli/latest/userguide/installing.html

Run the command to log into docker with the AWS ECR repositories.

```shell
eval $(aws ecr get-login --region us-west-2 --no-include-email)
```

Create a .env file, fill it with the environment variables for config
These parameters include the API keys, the duration a requested ravello environment lasts (in minutes), the time until a cloudshare request expires(days), the amount of requests allowed per user per day (resets at UTC 0:00), and the opportunity the request will be listed under in cloudshare.

```shell
# Cloudshare Setup
CLOUDSHARE_ID=
CLOUDSHARE_KEY=
CLOUDSHARE_OPPORTUNITY=

# Ravello Setup
RAVELLO_EMAIL=
RAVELLO_PASSWORD=

# Request Mode Settings

# Duration of Ravello Environment once started
REQUEST_DURATION=120

# Length of time invitation is valid for
REQUEST_EXPIRATION=7

# Request limit per 24 hours
REQUEST_LIMIT=3

# AWS Setup
AWS_KEY=
AWS_SECRET=

# Splunk Setup
SPLUNK_URL=
SPLUNK_TOKEN=

# Azure Setup
AZURE_SUBSCRIPTION=

#Qwiklab credentials, this account must be able to generate tokens
QWIKLAB_EMAIL=
QWIKLAB_PASSWORD=
```

Change the hostname of the instance for splunk log filtering

```shell
sudo hostnamectl set-hostname webserver.localdomain
sudo reboot
```

### SSL Certificate Generation

The server by default operates using a self-signed SSL Certificate. If desired this certificate can be replaced by a signed Let's Encrypt Certificate using the following steps. Please note a domain name is required for this.

Generate an SSL Certificate using Certbot
First install Certbot

```shell
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install certbot
```

Then run certbot and follow the instructions to generate a Certificate

```
sudo certbot certonly
```

Then modify the docker-compose.yml file to point to the generated certificates. In the last section under NGINX Volumes you should see two paths such as pointing to the cert and key. Change the part before the colon to the paths outputed by certbot. The part before the colon is the location of the certificate on your local machine. The part after the colon is the location of the certificate in the docker-container that NGINX looks towards. Do not change the second part unless the NGINX config is also changed.

Then setup a cron job to auto renew the cert.

```shell
sudo crontab -e
```

Place the following at the end of the file then save and close it.

```shell
0 23 * * * certbot renew
```

Run the Docker image

```shell
sudo docker-compose up -d
```

Copy the certificates to docker and restart it

```shell
docker cp -L /etc/letsencrypt/live/$FQDN/fullchain.pem front-end:/etc/letsencrypt/live/fullchain.pem
docker cp -L /etc/letsencrypt/live/$FQDN/privkey.pem front-end:/etc/letsencrypt/live/privkey.pem
docker-compose restart front-end
```

You should now be able to access the portal over an HTTPS connection. Make sure Port 443 is allowed through the firewall. The default credentials are admin/password. **Immediately add a new admin account under the users tab, log-out of the default account, log into the new account, and delete the default account.**

**Please note you will get many errors until all settings are filled out. Please go to settings and select a cloudshare project, policy, and ravello cost bucket**

### Updating

To update the server to the latest code on the master branch run the following sequence of commands

```shell
cd cloudspin
git pull
docker-compose up --build
```

### Useful commands

```shell
docker-compose exec SERVICE COMMAND
```

will run a command on a container. For example:

```shell
docker-compose exec mongo bash
```

will open the bash prompt on the mongo container.

### DB-scripts

There are a couple of scripts located in the ./mongo/db-scripts folder. These include a script to get a CSV for the request archives, get a csv for the class archives, and scripts to clear archives.

The CSV files will be output in the ./mongo/db-scripts directory.

To run these scripts:

```shell
docker-compose run mongo-scripts bash
cd /scripts
python SCRIPT_NAME.py
```

Then exit the shell and look for the file on the host system.

### Database backup and restore

Create a copy of the data folder in the project directory. If the database needs to be restored type

```shell
sudo docker-compose stop mongo
```

Copy the DB backup and replace the data folder

```shell
sudo docker-compose start mongo
```

## Developing

### Built With

Flask Python Framework  
ReactJS  
MongoDB

### Prerequisites

Python 3, Node 10.5, MongoDB

### Setting up Dev

First install the Prerequisites and clone the git Repo

In the project root create a file .env with the above variables. If doing Development behind a NGFW with SSL Decrypt enabled then add one more "Debug=True". Also add one more "MONGO_URL" env var containing the link to your dev database. For example:

```shell
export MONGO_URL='mongodb://user:password@localhost'
```

Then create a python virtual environment and init the DB:

```shell
virtualenv -p python3 .virtualenv
source .virtualenv/bin/activate
pip install -r requirements.txt
python createAdmin.py
python createSettings.py
```

Then start the back-end API

```shell
python run-dev.py
```

Open a new terminal window and change directories into the front-end folder

```shell
cd front-end
npm install
npm start
```

The application should now open in the browser window.

###DB Structure
Collections

- Archive - Contains an Archive of the users that have registered for a class
- Blacklist - Contains an entry for each email on the Blacklist
- Classes - Contains each class scheduled
- Hot - Contains a list of hot environments for each lab
- Labs - Contains a list of Labs
- Request Logs - Contains a log of every user request
- Requests - Contains every request listed by user
- Settings - Contains settings configurable from the web ui
- Users - Contains all users for the portal
- Whitelist - Contains and entry for each email on the whitelist
